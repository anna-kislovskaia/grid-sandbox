<html>
<head>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css"
          integrity="sha384-JcKb8q3iqJ61gNV9KGb8thSsNjpSL0n8PARn9HuZOnIxN0hoP+VmmDGMN5t9UJ0Z" crossorigin="anonymous">
    <script src="https://code.jquery.com/jquery-3.5.1.slim.min.js"
            integrity="sha384-DfXdz2htPH0lsSSs5nCTpuj/zy4C+OGpamoFVy38MVBnE+IbbVYUew+OrCXaRkfj"
            crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.1/dist/umd/popper.min.js"
            integrity="sha384-9/reFTGAW83EW2RDu2S0VKaIzap3H66lZH81PoYlFhbGU+6BZp6G7niu735Sk7lN"
            crossorigin="anonymous"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"
            integrity="sha384-B4gt1jrGC7Jh4AgTPSdUtOBvfO8shuf57BaghqFfPlYxofvL8/KUEfYiJOMMV+rV"
            crossorigin="anonymous"></script>

    <script lang="javascript">
            var eventStream;

            function stopEventStream() {
                if (eventStream) {
                    eventStream.close();
                }
            }

            function resetEventStream() {
                stopEventStream();
                const dataContainer = document.getElementById('data');
                dataContainer.innerHTML = '';
                const selector = document.getElementById('reportType');
                const reportType = selector.options[selector.selectedIndex].value;
                const pageNumber = document.getElementById('pageNumber').value;
                const pageSize = document.getElementById('pageSize').value;
                const sort = document.getElementById('sort').value;
                let url = `/trades/${reportType}/?`;
                if (pageNumber && !Number.isNaN(Number.parseInt(pageNumber))) {
                    url += `page=${pageNumber}&`;
                }
                if (pageSize && !Number.isNaN(Number.parseInt(pageSize))) {
                    url += `size=${pageSize}&`;
                }
                if (sort) {
                    url += `sort=${sort}&`;
                }
                console.log(`Subscribing to ${url}`);
                eventStream = new EventSource(url, { withCredentials: true } );
                eventStream.onmessage = function(message) {
                    const contentElement = document.createElement("div");

                    const data = JSON.parse(message.data);
                    let content = `<h2>${data.snapshot ? "Snapshot" : "Update"}</h2>`;
                    content += '<ol class="list-group">';
                    data.updated.map(row => {
                        content += `<li class="list-group-item text-nowrap">${JSON.stringify(row)}</li>`;
                    });
                    data.deleted.map(row => {
                        content += `<li class="list-group-item text-nowrap list-group-item-dark">${JSON.stringify(row)}</li>`;
                    });
                    content += '</ol>';
                    contentElement.innerHTML = content;
                    dataContainer.insertBefore(contentElement, dataContainer.firstChild);
                };
            }

            console.log("Loading");
    </script>
</head>
<body>
<div class="container">
    <div class="row">
        <div class="col-12">
            <div class="form-group">
                <label for="reportType">Report Type</label>
                <select class="form-control" id="reportType">
                    <option value="open" selected>Open</option>
                    <option value="all">All</option>
                </select>
            </div>
        </div>
    </div>
    <div class="row">
        <div class="col-6">
            <div class="form-group">
                <label for="pageNumber">Page Number</label>
                <input type="text" class="form-control" id="pageNumber">
            </div>
        </div>
        <div class="col-6">
            <div class="form-group">
                <label for="pageSize">Page Size</label>
                <input type="text" class="form-control" id="pageSize">
            </div>
        </div>
    </div>
    <div class="row">
        <div class="col-12">
            <div class="form-group">
                <label for="sort">Sort</label>
                <input type="text" class="form-control" id="sort">
            </div>
        </div>
    </div>
    <div class="row">
        <div class="col-6">
            <button class="btn btn-primary" onclick="resetEventStream()">Subscribe</button>
            <button class="btn btn-primary" onclick="stopEventStream()">Stop Updates</button>
        </div>
    </div>
    <div class="row">
        <div id="data" class="col-12">

        </div>
    </div>
</div>
</body>
</html>